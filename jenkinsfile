pipeline {
    agent any
	enviroment{
		DOCKER_IMAGE='properties'	
	}
    stages {
        stage('sourcedownload') {
            steps {
                git credentialsId: 'msgreceiver', url: 'https://github.com/Ramesh14973/properties.git'
            } // End of steps
        } // End of stage-sourcedownload
        stage('mvn test') {
            steps {
                sh 'mvn test'
            } // End of steps-test
        } // End of stage mvn test
        stage('mvn build') {
            steps {
                sh 'mvn clean install -DskipTests=true'
            } // End of steps-clean and install
        } // End of stage-build
        stage('docker login') {
            steps {
                sh 'docker login -u "rameshsubramani" docker.io -p Ramesh!4973'
            } // End of steps-clean and install
        } // End of docker login
        stage('create Dcoker Image') {
            steps {
                sh 'docker build -t $DOCKER_IMAGE:$BUILD_NUMBER .'
            } // End of steps-clean and install
        } // End of create dockerimage
        stage('tag dockerimage') {
            steps {
                sh 'docker tag $DOCKER_IMAGE:$BUILD_NUMBER rameshsubramani/messagespark:latest'
            } // End of step
        } // End of tag dockerimage
        stage('push dockerimage') {
            steps {
                sh 'docker push rameshsubramani/messagespark:latest'
            } // End of step
        } // End of push dockerimage into docker hub
        stage('apply into kubectl') {
            steps {
                sh 'kubectl apply -f deployment.yaml'
            } // End of step
        } // End of deploy into kubectl
        stage('expose to service') { // expose into service with specific port 
            steps {
                sh 'kubectl expose deployment propertiesservice-v1 --port=8085 --target-port=8085  --name=properties-service --type=ClusterIP'
            } // End of step
        } // End of expose into service with specific port
        stage('patch IP to service') { // patch IP into service with specific port
            steps {
                sh 'kubectl patch svc properties-service -p \'{"spec":{"externalIPs":["192.168.0.102"]}}\''
            } // End of step
        } // End of patch IP into service with specific port
    } // End of stages
} // End of pipeline
